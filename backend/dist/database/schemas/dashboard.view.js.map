{"version":3,"sources":["../../../src/database/schemas/dashboard.view.ts"],"sourcesContent":["// ========================================\r\n// MATERIALIZED VIEWS untuk DASHBOARD\r\n// ========================================\r\n\r\nimport { eq, sql } from \"drizzle-orm\";\r\nimport { pgMaterializedView } from \"drizzle-orm/pg-core\";\r\nimport { queueCalls, queues } from \"./queue.schema\";\r\nimport { clinics, staff } from \"./master.schema\";\r\n\r\n// View 1: Dashboard Summary (Real-time stats)\r\nexport const dashboardSummary = pgMaterializedView(\"dashboard_summary\").as(\r\n  (qb) =>\r\n    qb\r\n      .select({\r\n        totalWaiting:\r\n          sql<number>`COUNT(*) FILTER (WHERE status = 'Waiting')`.as(\r\n            \"total_waiting\"\r\n          ),\r\n        totalCalled: sql<number>`COUNT(*) FILTER (WHERE status = 'Called')`.as(\r\n          \"total_called\"\r\n        ),\r\n        totalDone: sql<number>`COUNT(*) FILTER (WHERE status = 'Done')`.as(\r\n          \"total_done\"\r\n        ),\r\n        totalCancelled:\r\n          sql<number>`COUNT(*) FILTER (WHERE status = 'Cancelled')`.as(\r\n            \"total_cancelled\"\r\n          ),\r\n        totalReservation:\r\n          sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Reservasi')`.as(\r\n            \"total_reservation\"\r\n          ),\r\n        totalWalkin:\r\n          sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Walk-In')`.as(\r\n            \"total_walkin\"\r\n          ),\r\n        avgServiceTimeMinutes: sql<number>`\r\n      AVG(EXTRACT(EPOCH FROM (completed_at - called_at))/60) \r\n      FILTER (WHERE completed_at IS NOT NULL AND called_at IS NOT NULL)\r\n    `.as(\"avg_service_time_minutes\"),\r\n        lastUpdated: sql<Date>`NOW()`.as(\"last_updated\"),\r\n      })\r\n      .from(queues)\r\n      .where(sql`DATE(created_at) = CURRENT_DATE`)\r\n);\r\n\r\n// View 2: Queue Stats per Staff (Antrian per staff hari ini)\r\nexport const queueStatsByStaff = pgMaterializedView(\"queue_stats_by_staff\").as(\r\n  (qb) =>\r\n    qb\r\n      .select({\r\n        staffId: sql<string>`{staff.id}`.as(\"staff_id\"),\r\n        staffCode: sql<string>`{staff.code}`.as(\"staff_code\"),\r\n        staffName: sql<string>`{staff.name}`.as(\"staff_name\"),\r\n        totalWaiting:\r\n          sql<number>`COUNT(*) FILTER (WHERE ${queues.status} = 'Waiting')`.as(\r\n            \"total_waiting\"\r\n          ),\r\n        totalCalled:\r\n          sql<number>`COUNT(*) FILTER (WHERE ${queues.status} = 'Called')`.as(\r\n            \"total_called\"\r\n          ),\r\n        totalDone:\r\n          sql<number>`COUNT(*) FILTER (WHERE ${queues.status} = 'Done')`.as(\r\n            \"total_done\"\r\n          ),\r\n        totalQueues: sql<number>`COUNT(*)`.as(\"total_queues\"),\r\n        avgWaitingTimeMinutes: sql<number>`\r\n          AVG(EXTRACT(EPOCH FROM (COALESCE(${queues.calledAt}, NOW()) - ${queues.createdAt}))/60)\r\n        `.as(\"avg_waiting_time_minutes\"),\r\n        lastUpdated: sql<Date>`NOW()`.as(\"last_updated\"),\r\n      })\r\n      .from(staff)\r\n      .leftJoin(\r\n        queues,\r\n        sql`${queues.staffId} = ${staff.id} AND DATE(${queues.createdAt}) = CURRENT_DATE`\r\n      )\r\n      .where(eq(staff.isActive, true))\r\n      .groupBy(staff.id, staff.code, staff.name)\r\n);\r\n\r\n// View 3: Staff Performance (Top staff hari ini)\r\nexport const staffPerformance = pgMaterializedView(\"staff_performance\").as(\r\n  (qb) =>\r\n    qb\r\n      .select({\r\n        staffId: sql<string>`{staff.id}`.as(\"staff_id\"),\r\n        staffCode: sql<string>`{staff.code}`.as(\"staff_code\"),\r\n        staffName: sql<string>`{staff.name}`.as(\"staff_name\"),\r\n        loketNumber: sql<string>`{staff.loketNumber}`.as(\"loket_number\"),\r\n        clinicName: sql<string>`${clinics.name}`.as(\"clinic_name\"),\r\n        totalServed: sql<number>`COUNT(${queues.id})`.as(\"total_served\"),\r\n        avgServiceTimeMinutes: sql<number>`\r\n      AVG(EXTRACT(EPOCH FROM (${queues.completedAt} - ${queues.calledAt}))/60)\r\n    `.as(\"avg_service_time_minutes\"),\r\n        totalCallAttempts: sql<number>`COUNT(${queueCalls.id})`.as(\r\n          \"total_call_attempts\"\r\n        ),\r\n        lastServiceAt: sql<Date>`MAX(${queues.completedAt})`.as(\r\n          \"last_service_at\"\r\n        ),\r\n        lastUpdated: sql<Date>`NOW()`.as(\"last_updated\"),\r\n      })\r\n      .from(staff)\r\n      .leftJoin(clinics, sql`${staff.clinicId} = ${clinics.id}`)\r\n      .leftJoin(\r\n        queues,\r\n        sql`${queues.staffId} = ${staff.id} AND ${queues.status} = 'Done' AND DATE(${queues.createdAt}) = CURRENT_DATE`\r\n      )\r\n      .leftJoin(queueCalls, sql`${queueCalls.queueId} = ${queues.id}`)\r\n      .where(sql`${staff.isActive} = true`)\r\n      .orderBy(sql`total_served DESC`)\r\n      .groupBy(\r\n        staff.id,\r\n        staff.code,\r\n        staff.name,\r\n        staff.loketNumber,\r\n        clinics.name\r\n      )\r\n);\r\n\r\n// View 4: Hourly Queue Distribution (Distribusi antrian per jam)\r\nexport const hourlyQueueDistribution = pgMaterializedView(\r\n  \"hourly_queue_distribution\"\r\n).as((qb) =>\r\n  qb\r\n    .select({\r\n      hour: sql<number>`EXTRACT(HOUR FROM created_at)`.as(\"hour\"),\r\n      totalReservation:\r\n        sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Reservasi')`.as(\r\n          \"total_reservation\"\r\n        ),\r\n      totalWalkin:\r\n        sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Walk-In')`.as(\r\n          \"total_walkin\"\r\n        ),\r\n      totalQueues: sql<number>`COUNT(*)`.as(\"total_queues\"),\r\n      avgProcessingMinutes: sql<number>`\r\n      AVG(EXTRACT(EPOCH FROM (completed_at - called_at))/60) \r\n      FILTER (WHERE completed_at IS NOT NULL)\r\n    `.as(\"avg_processing_minutes\"),\r\n    })\r\n    .from(queues)\r\n    .where(sql`DATE(created_at) = CURRENT_DATE`)\r\n    .groupBy(sql`EXTRACT(HOUR FROM created_at)`)\r\n    .orderBy(sql`hour`)\r\n);\r\n"],"names":["dashboardSummary","hourlyQueueDistribution","queueStatsByStaff","staffPerformance","pgMaterializedView","as","qb","select","totalWaiting","sql","totalCalled","totalDone","totalCancelled","totalReservation","totalWalkin","avgServiceTimeMinutes","lastUpdated","from","queues","where","staffId","staffCode","staffName","status","totalQueues","avgWaitingTimeMinutes","calledAt","createdAt","staff","leftJoin","id","eq","isActive","groupBy","code","name","loketNumber","clinicName","clinics","totalServed","completedAt","totalCallAttempts","queueCalls","lastServiceAt","clinicId","queueId","orderBy","hour","avgProcessingMinutes"],"mappings":"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"}