{"version":3,"sources":["../../../src/database/schemas/dashboard.view.ts"],"sourcesContent":["// ========================================\r\n// MATERIALIZED VIEWS untuk DASHBOARD\r\n// ========================================\r\n\r\nimport { sql } from \"drizzle-orm\";\r\nimport { pgMaterializedView } from \"drizzle-orm/pg-core\";\r\nimport { queueCalls, queues } from \"./queue.schema\";\r\nimport { clinics, staff } from \"./master.schema\";\r\n\r\n// View 1: Dashboard Summary (Real-time stats)\r\nexport const dashboardSummary = pgMaterializedView(\"dashboard_summary\").as(\r\n  (qb) =>\r\n    qb\r\n      .select({\r\n        totalWaiting:\r\n          sql<number>`COUNT(*) FILTER (WHERE status = 'Waiting')`.as(\r\n            \"total_waiting\"\r\n          ),\r\n        totalCalled: sql<number>`COUNT(*) FILTER (WHERE status = 'Called')`.as(\r\n          \"total_called\"\r\n        ),\r\n        totalDone: sql<number>`COUNT(*) FILTER (WHERE status = 'Done')`.as(\r\n          \"total_done\"\r\n        ),\r\n        totalCancelled:\r\n          sql<number>`COUNT(*) FILTER (WHERE status = 'Cancelled')`.as(\r\n            \"total_cancelled\"\r\n          ),\r\n        totalReservation:\r\n          sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Reservation')`.as(\r\n            \"total_reservation\"\r\n          ),\r\n        totalWalkin:\r\n          sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Walkin')`.as(\r\n            \"total_walkin\"\r\n          ),\r\n        avgServiceTimeMinutes: sql<number>`\r\n      AVG(EXTRACT(EPOCH FROM (completed_at - called_at))/60) \r\n      FILTER (WHERE completed_at IS NOT NULL AND called_at IS NOT NULL)\r\n    `.as(\"avg_service_time_minutes\"),\r\n        lastUpdated: sql<Date>`NOW()`.as(\"last_updated\"),\r\n      })\r\n      .from(queues)\r\n      .where(sql`DATE(created_at) = CURRENT_DATE`)\r\n);\r\n\r\n// View 2: Queue Stats per Clinics (Antrian per clinics hari ini)\r\nexport const queueStatsByClinics = pgMaterializedView(\r\n  \"queue_stats_by_clinic\"\r\n).as((qb) =>\r\n  qb\r\n    .select({\r\n      clinicId: clinics.id,\r\n      clinicCode: clinics.code,\r\n      clinicName: clinics.name,\r\n      totalWaiting:\r\n        sql<number>`COUNT(*) FILTER (WHERE ${queues.status} = 'Waiting')`.as(\r\n          \"total_waiting\"\r\n        ),\r\n      totalCalled:\r\n        sql<number>`COUNT(*) FILTER (WHERE ${queues.status} = 'Called')`.as(\r\n          \"total_called\"\r\n        ),\r\n      totalDone:\r\n        sql<number>`COUNT(*) FILTER (WHERE ${queues.status} = 'Done')`.as(\r\n          \"total_done\"\r\n        ),\r\n      totalQueues: sql<number>`COUNT(*)`.as(\"total_queues\"),\r\n      avgWaitingTimeMinutes: sql<number>`\r\n          AVG(EXTRACT(EPOCH FROM (COALESCE(${queues.calledAt}, NOW()) - ${queues.createdAt}))/60)\r\n        `.as(\"avg_waiting_time_minutes\"),\r\n      lastUpdated: sql<Date>`NOW()`.as(\"last_updated\"),\r\n    })\r\n    .from(clinics)\r\n    .leftJoin(\r\n      queues,\r\n      sql`${queues.clinicId} = ${clinics.id} AND DATE(${queues.createdAt}) = CURRENT_DATE`\r\n    )\r\n    .groupBy(clinics.id, clinics.code, clinics.name)\r\n);\r\n\r\n// View 3: Staff Performance (Top staff hari ini)\r\nexport const staffPerformance = pgMaterializedView(\"staff_performance\").as(\r\n  (qb) =>\r\n    qb\r\n      .select({\r\n        staffId: staff.id,\r\n        staffCode: staff.code,\r\n        staffName: sql`${staff.name}`.as(\"staff_name\"),\r\n        loketNumber: staff.loketNumber,\r\n        clinicName: sql`${clinics.name}`.as(\"clinic_name\"),\r\n        totalServed: sql<number>`COUNT(${queues.id})`.as(\"total_served\"),\r\n        avgServiceTimeMinutes: sql<number>`\r\n      AVG(EXTRACT(EPOCH FROM (${queues.completedAt} - ${queues.calledAt}))/60)\r\n    `.as(\"avg_service_time_minutes\"),\r\n        totalCallAttempts: sql<number>`COUNT(${queueCalls.id})`.as(\r\n          \"total_call_attempts\"\r\n        ),\r\n        lastServiceAt: sql<Date>`MAX(${queues.completedAt})`.as(\r\n          \"last_service_at\"\r\n        ),\r\n        lastUpdated: sql<Date>`NOW()`.as(\"last_updated\"),\r\n      })\r\n      .from(staff)\r\n      .leftJoin(clinics, sql`${staff.clinicId} = ${clinics.id}`)\r\n      .leftJoin(\r\n        queues,\r\n        sql`${queues.staffId} = ${staff.id} AND ${queues.status} = 'Done' AND DATE(${queues.createdAt}) = CURRENT_DATE`\r\n      )\r\n      .leftJoin(queueCalls, sql`${queueCalls.queueId} = ${queues.id}`)\r\n      .where(sql`${staff.isActive} = true`)\r\n      .groupBy(\r\n        staff.id,\r\n        staff.code,\r\n        staff.name,\r\n        staff.loketNumber,\r\n        clinics.name\r\n      )\r\n);\r\n\r\n// View 4: Hourly Queue Distribution (Distribusi antrian per jam)\r\nexport const hourlyQueueDistribution = pgMaterializedView(\r\n  \"hourly_queue_distribution\"\r\n).as((qb) =>\r\n  qb\r\n    .select({\r\n      hour: sql<number>`EXTRACT(HOUR FROM created_at)`.as(\"hour\"),\r\n      totalReservation:\r\n        sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Reservation')`.as(\r\n          \"total_reservation\"\r\n        ),\r\n      totalWalkin:\r\n        sql<number>`COUNT(*) FILTER (WHERE queue_type = 'Walkin')`.as(\r\n          \"total_walkin\"\r\n        ),\r\n      totalQueues: sql<number>`COUNT(*)`.as(\"total_queues\"),\r\n      avgProcessingMinutes: sql<number>`\r\n      AVG(EXTRACT(EPOCH FROM (completed_at - called_at))/60) \r\n      FILTER (WHERE completed_at IS NOT NULL)\r\n    `.as(\"avg_processing_minutes\"),\r\n    })\r\n    .from(queues)\r\n    .where(sql`DATE(created_at) = CURRENT_DATE`)\r\n    .groupBy(sql`EXTRACT(HOUR FROM created_at)`)\r\n    .orderBy(sql`hour`)\r\n);\r\n"],"names":["dashboardSummary","hourlyQueueDistribution","queueStatsByClinics","staffPerformance","pgMaterializedView","as","qb","select","totalWaiting","sql","totalCalled","totalDone","totalCancelled","totalReservation","totalWalkin","avgServiceTimeMinutes","lastUpdated","from","queues","where","clinicId","clinics","id","clinicCode","code","clinicName","name","status","totalQueues","avgWaitingTimeMinutes","calledAt","createdAt","leftJoin","groupBy","staffId","staff","staffCode","staffName","loketNumber","totalServed","completedAt","totalCallAttempts","queueCalls","lastServiceAt","queueId","isActive","hour","avgProcessingMinutes","orderBy"],"mappings":"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"}