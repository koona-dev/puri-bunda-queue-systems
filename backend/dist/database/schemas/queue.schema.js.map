{"version":3,"sources":["../../../src/database/schemas/queue.schema.ts"],"sourcesContent":["import { relations } from \"drizzle-orm\";\r\nimport {\r\n  date,\r\n  index,\r\n  integer,\r\n  pgTable,\r\n  text,\r\n  time,\r\n  timestamp,\r\n  uniqueIndex,\r\n  uuid,\r\n  varchar,\r\n} from \"drizzle-orm/pg-core\";\r\nimport {\r\n  priority,\r\n  queueStatus,\r\n  queueType,\r\n  referenceType,\r\n  serviceType,\r\n} from \"../helpers/enums\";\r\nimport { clinics, doctors, patients, staff } from \"./master.schema\";\r\nimport { timestamps } from \"../helpers/timestamps\";\r\n\r\n// ========================================\r\n// MODUL ANTRIAN\r\n// ========================================\r\n\r\nexport const queues = pgTable(\r\n  \"queues\",\r\n  {\r\n    id: uuid().defaultRandom().primaryKey(),\r\n    patientId: integer(\"patient_id\").references(() => patients.id, {\r\n      onDelete: \"set null\",\r\n    }),\r\n    clinicId: integer(\"clinic_id\")\r\n      .notNull()\r\n      .references(() => clinics.id, { onDelete: \"cascade\" }),\r\n    doctorId: integer(\"doctor_id\").references(() => doctors.id, {\r\n      onDelete: \"set null\",\r\n    }),\r\n    staffId: integer(\"staff_id\").references(() => staff.id, {\r\n      onDelete: \"set null\",\r\n    }),\r\n    queueNumber: varchar(\"queue_number\", { length: 20 }).notNull().unique(),\r\n    queueType: queueType(\"queue_type\").notNull(),\r\n    priority: priority(\"priority\").default(\"Normal\").notNull(), // BARU: prioritas antrian\r\n    serviceType: serviceType(\"service_type\").notNull(),\r\n    referenceType: referenceType(\"reference_type\").notNull(),\r\n    chiefComplaint: text(\"chief_complaint\"), // Keluhan utama\r\n    symptoms: text(\"symptoms\"), // Gejala yang dirasakan\r\n    symptomsStartDate: date(\"symptoms_start_date\"), // Sejak kapan\r\n    previousTreatment: text(\"previous_treatment\"), // Pengobatan yang sudah dilakukan\r\n    reservationDate: date(\"reservation_date\"),\r\n    preferredTime: time(\"preferred_time\"), // BARU: Jam yang diinginkan\r\n    status: queueStatus(\"status\").default(\"Waiting\").notNull(),\r\n    calledAt: timestamp(\"called_at\"),\r\n    completedAt: timestamp(\"completed_at\"),\r\n    staffNotes: text(\"staff_notes\"),\r\n    cancellationReason: text(\"cancellation_reason\"),\r\n    ...timestamps,\r\n  },\r\n  (table) => [\r\n    uniqueIndex(\"queues_queue_number_idx\").on(table.queueNumber),\r\n    index(\"queues_status_idx\").on(table.status),\r\n    index(\"queues_type_idx\").on(table.queueType),\r\n    index(\"queues_priority_idx\").on(table.priority),\r\n    index(\"queues_clinic_idx\").on(table.clinicId),\r\n    index(\"queues_date_idx\").on(table.createdAt),\r\n    index(\"queues_status_clinic_idx\").on(table.status, table.clinicId),\r\n    index(\"queues_reservation_date_idx\").on(table.reservationDate),\r\n  ]\r\n);\r\n\r\nexport type QueuesSchema = typeof queues.$inferSelect; // return type when queried\r\nexport type NewQueue = typeof queues.$inferInsert; // insert type\r\n\r\nexport const queueCalls = pgTable(\r\n  \"queue_calls\",\r\n  {\r\n    id: uuid().defaultRandom().primaryKey(),\r\n    queueId: uuid(\"queue_id\")\r\n      .notNull()\r\n      .references(() => queues.id, { onDelete: \"cascade\" }),\r\n    staffId: uuid(\"staff_id\")\r\n      .notNull()\r\n      .references(() => staff.id, { onDelete: \"cascade\" }),\r\n    calledAt: timestamp(\"called_at\").defaultNow().notNull(),\r\n    responseTime: integer(\"response_time\"), // Berapa lama pasien respon (dalam detik)\r\n    ...timestamps,\r\n  },\r\n  (table) => [\r\n    index(\"queue_calls_queue_idx\").on(table.queueId),\r\n    index(\"queue_calls_staff_idx\").on(table.staffId),\r\n  ]\r\n);\r\n\r\nexport type QueueCallsSchema = typeof queueCalls.$inferSelect; // return type when queried\r\nexport type NewQueueCall = typeof queueCalls.$inferInsert; // insert type\r\n\r\n// ========================================\r\n// RELATIONS\r\n// ========================================\r\n\r\nexport const queuesRelations = relations(queues, ({ one, many }) => ({\r\n  patient: one(patients, {\r\n    fields: [queues.patientId],\r\n    references: [patients.id],\r\n  }),\r\n  clinic: one(clinics, {\r\n    fields: [queues.clinicId],\r\n    references: [clinics.id],\r\n  }),\r\n  doctor: one(doctors, {\r\n    fields: [queues.doctorId],\r\n    references: [doctors.id],\r\n  }),\r\n  staff: one(staff, {\r\n    fields: [queues.staffId],\r\n    references: [staff.id],\r\n  }),\r\n  calls: many(queueCalls),\r\n}));\r\n\r\nexport const queueCallsRelations = relations(queueCalls, ({ one }) => ({\r\n  staff: one(staff, {\r\n    fields: [queueCalls.staffId],\r\n    references: [staff.id],\r\n  }),\r\n  queues: one(queues, {\r\n    fields: [queueCalls.queueId],\r\n    references: [queues.id],\r\n  }),\r\n}));\r\n"],"names":["queueCalls","queueCallsRelations","queues","queuesRelations","pgTable","id","uuid","defaultRandom","primaryKey","patientId","integer","references","patients","onDelete","clinicId","notNull","clinics","doctorId","doctors","staffId","staff","queueNumber","varchar","length","unique","queueType","priority","default","serviceType","referenceType","chiefComplaint","text","symptoms","symptomsStartDate","date","previousTreatment","reservationDate","preferredTime","time","status","queueStatus","calledAt","timestamp","completedAt","staffNotes","cancellationReason","timestamps","table","uniqueIndex","on","index","createdAt","queueId","defaultNow","responseTime","relations","one","many","patient","fields","clinic","doctor","calls"],"mappings":"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"}