{"version":3,"sources":["../../../src/database/schemas/queue.schema.ts"],"sourcesContent":["import { relations } from \"drizzle-orm\";\r\nimport {\r\n  date,\r\n  index,\r\n  integer,\r\n  pgTable,\r\n  text,\r\n  time,\r\n  timestamp,\r\n  uniqueIndex,\r\n  uuid,\r\n  varchar,\r\n} from \"drizzle-orm/pg-core\";\r\nimport {\r\n  priority,\r\n  queueStatus,\r\n  queueType,\r\n  referenceType,\r\n  serviceType,\r\n} from \"../helpers/enums\";\r\nimport { clinics, doctors, patients, staff } from \"./master.schema\";\r\nimport { timestamps } from \"../helpers/timestamps\";\r\n\r\n// ========================================\r\n// MODUL ANTRIAN\r\n// ========================================\r\n\r\nexport const queues = pgTable(\r\n  \"queues\",\r\n  {\r\n    id: uuid().defaultRandom().primaryKey(),\r\n    patientId: uuid(\"patient_id\")\r\n      .references(() => patients.id, {\r\n        onDelete: \"set null\",\r\n      })\r\n      .notNull(),\r\n    clinicId: uuid(\"clinic_id\")\r\n      .references(() => clinics.id, { onDelete: \"cascade\" })\r\n      .notNull(),\r\n    doctorId: uuid(\"doctor_id\")\r\n      .references(() => doctors.id, {\r\n        onDelete: \"set null\",\r\n      })\r\n      .notNull(),\r\n    staffId: uuid(\"staff_id\")\r\n      .references(() => staff.id, {\r\n        onDelete: \"set null\",\r\n      })\r\n      .notNull(),\r\n    queueNumber: varchar(\"queue_number\").notNull().unique(),\r\n    queueType: queueType(\"queue_type\").notNull(),\r\n    priority: priority(\"priority\").default(\"Normal\").notNull(), // BARU: prioritas antrian\r\n    serviceType: serviceType(\"service_type\").notNull(),\r\n    referenceType: referenceType(\"reference_type\").notNull(),\r\n    chiefComplaint: text(\"chief_complaint\").notNull(), // Keluhan utama\r\n    symptoms: text(\"symptoms\").notNull(), // Gejala yang dirasakan\r\n    symptomsStartDate: date(\"symptoms_start_date\", { mode: \"date\" }).notNull(), // Sejak kapan\r\n    previousTreatment: text(\"previous_treatment\"), // Pengobatan yang sudah dilakukan\r\n    reservationDate: date(\"reservation_date\", { mode: \"date\" }).notNull(),\r\n    preferredTime: time(\"preferred_time\").notNull(), // BARU: Jam yang diinginkan\r\n    status: queueStatus(\"status\").default(\"Waiting\").notNull(),\r\n    calledAt: timestamp(\"called_at\", { mode: \"date\" }),\r\n    completedAt: timestamp(\"completed_at\", { mode: \"date\" }),\r\n    staffNotes: text(\"staff_notes\"),\r\n    cancellationReason: text(\"cancellation_reason\"),\r\n    ...timestamps,\r\n  },\r\n  (table) => [\r\n    uniqueIndex(\"queues_queue_number_idx\").on(table.queueNumber),\r\n    index(\"queues_status_idx\").on(table.status),\r\n    index(\"queues_type_idx\").on(table.queueType),\r\n    index(\"queues_priority_idx\").on(table.priority),\r\n    index(\"queues_clinic_idx\").on(table.clinicId),\r\n    index(\"queues_date_idx\").on(table.createdAt),\r\n    index(\"queues_status_clinic_idx\").on(table.status, table.clinicId),\r\n    index(\"queues_reservation_date_idx\").on(table.reservationDate),\r\n  ]\r\n);\r\n\r\nexport type QueuesSchema = typeof queues.$inferSelect; // return type when queried\r\nexport type NewQueue = typeof queues.$inferInsert; // insert type\r\n\r\nexport const queueCalls = pgTable(\r\n  \"queue_calls\",\r\n  {\r\n    id: uuid().defaultRandom().primaryKey(),\r\n    queueId: uuid(\"queue_id\")\r\n      .notNull()\r\n      .references(() => queues.id, { onDelete: \"cascade\" }),\r\n    staffId: uuid(\"staff_id\")\r\n      .notNull()\r\n      .references(() => staff.id, { onDelete: \"set null\" }),\r\n    calledAt: timestamp(\"called_at\").defaultNow(),\r\n    responseTime: integer(\"response_time\"), // Berapa lama pasien respon (dalam detik)\r\n    ...timestamps,\r\n  },\r\n  (table) => [\r\n    index(\"queue_calls_queue_idx\").on(table.queueId),\r\n    index(\"queue_calls_staff_idx\").on(table.staffId),\r\n  ]\r\n);\r\n\r\nexport type QueueCallsSchema = typeof queueCalls.$inferSelect; // return type when queried\r\nexport type NewQueueCall = typeof queueCalls.$inferInsert; // insert type\r\n\r\n// ========================================\r\n// RELATIONS\r\n// ========================================\r\n\r\nexport const queuesRelations = relations(queues, ({ one, many }) => ({\r\n  patient: one(patients, {\r\n    fields: [queues.patientId],\r\n    references: [patients.id],\r\n  }),\r\n  clinic: one(clinics, {\r\n    fields: [queues.clinicId],\r\n    references: [clinics.id],\r\n  }),\r\n  doctor: one(doctors, {\r\n    fields: [queues.doctorId],\r\n    references: [doctors.id],\r\n  }),\r\n  staff: one(staff, {\r\n    fields: [queues.staffId],\r\n    references: [staff.id],\r\n  }),\r\n  calls: many(queueCalls),\r\n}));\r\n\r\nexport const queueCallsRelations = relations(queueCalls, ({ one }) => ({\r\n  staff: one(staff, {\r\n    fields: [queueCalls.staffId],\r\n    references: [staff.id],\r\n  }),\r\n  queues: one(queues, {\r\n    fields: [queueCalls.queueId],\r\n    references: [queues.id],\r\n  }),\r\n}));\r\n"],"names":["queueCalls","queueCallsRelations","queues","queuesRelations","pgTable","id","uuid","defaultRandom","primaryKey","patientId","references","patients","onDelete","notNull","clinicId","clinics","doctorId","doctors","staffId","staff","queueNumber","varchar","unique","queueType","priority","default","serviceType","referenceType","chiefComplaint","text","symptoms","symptomsStartDate","date","mode","previousTreatment","reservationDate","preferredTime","time","status","queueStatus","calledAt","timestamp","completedAt","staffNotes","cancellationReason","timestamps","table","uniqueIndex","on","index","createdAt","queueId","defaultNow","responseTime","integer","relations","one","many","patient","fields","clinic","doctor","calls"],"mappings":"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"}