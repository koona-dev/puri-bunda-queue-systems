{"version":3,"sources":["../../../src/modules/auth/auth.controller.ts"],"sourcesContent":["import {\r\n  Body,\r\n  Controller,\r\n  Inject,\r\n  InternalServerErrorException,\r\n  Post,\r\n  Req,\r\n  UnauthorizedException,\r\n  UseGuards,\r\n} from \"@nestjs/common\";\r\n\r\nimport { ApiBody, ApiTags } from \"@nestjs/swagger\";\r\nimport { SignupBody } from \"./dto/signup.body\";\r\nimport { LoginPatientBody, LoginStaffBody } from \"./dto/login.body\";\r\nimport { CookieService } from \"./services/cookie.service\";\r\nimport JwtAuthenticationGuard from \"../../utils/guards/jwt-authentication.guard\";\r\nimport { AuthService } from \"./services/auth.service\";\r\nimport { comparePassword } from \"src/utils/encrypt\";\r\nimport { JwtAuthService } from \"./services/jwt-auth.service\";\r\nimport {\r\n  RequestWithPatient,\r\n  RequestWithStaff,\r\n} from \"./entities/req-user.entity\";\r\nimport { JwtPatient, JwtStaff } from \"./entities/jwt-user.entity\";\r\nimport { Staff } from \"../master/entities/staff.entity\";\r\nimport { Patients } from \"../master/entities/patients.entity\";\r\n\r\n@ApiTags(\"Authentication\")\r\n@Controller(\"auth\")\r\nexport class AuthController {\r\n  constructor(\r\n    @Inject(\"AUTH_SERVICE\")\r\n    private readonly authService: AuthService,\r\n    @Inject(\"JWT_AUTH_SERVICE\")\r\n    private readonly jwtAuthService: JwtAuthService,\r\n    @Inject(\"COOKIE_SERVICE\")\r\n    private readonly cookieService: CookieService\r\n  ) {}\r\n\r\n  @Post(\"/signup\")\r\n  @ApiBody({ type: SignupBody })\r\n  async signup(@Body() body: SignupBody) {\r\n    const user = await this.authService.register(body);\r\n    return user;\r\n  }\r\n\r\n  @Post(\"/login/staff\")\r\n  @ApiBody({ type: LoginStaffBody })\r\n  async loginStaff(\r\n    @Req() request: RequestWithStaff,\r\n    @Body() body: LoginStaffBody\r\n  ) {\r\n    const staff = await this.authService.getByUsername(body.username);\r\n\r\n    if (\r\n      !staff?.password ||\r\n      !(await comparePassword(staff.password, body.password))\r\n    ) {\r\n      throw new UnauthorizedException(\"Invalid Credentials!\");\r\n    }\r\n\r\n    const jwtUser = await this.jwtAuthService.generateJwtUser<Staff, JwtStaff>(\r\n      staff\r\n    );\r\n\r\n    if (request.res) {\r\n      if (!jwtUser.accessToken) {\r\n        throw new InternalServerErrorException(\"Tokens not generated\");\r\n      }\r\n\r\n      const cookies = [\r\n        await this.cookieService.generateCookie(jwtUser.accessToken),\r\n      ];\r\n      request.res.setHeader(\"Set-Cookie\", cookies);\r\n    }\r\n\r\n    return jwtUser;\r\n  }\r\n\r\n  @Post(\"/login/patient\")\r\n  @ApiBody({ type: LoginPatientBody })\r\n  async loginPatient(\r\n    @Req() request: RequestWithPatient,\r\n    @Body() body: LoginPatientBody\r\n  ) {\r\n    const patient = await this.authService.getByNik(body.nik);\r\n\r\n    if (!patient) {\r\n      throw new UnauthorizedException(\"Invalid Credentials!\");\r\n    }\r\n\r\n    const jwtUser = await this.jwtAuthService.generateJwtUser<\r\n      Patients,\r\n      JwtPatient\r\n    >(patient);\r\n\r\n    if (request.res) {\r\n      if (!jwtUser.accessToken) {\r\n        throw new InternalServerErrorException(\"Tokens not generated\");\r\n      }\r\n\r\n      const cookies = [\r\n        await this.cookieService.generateCookie(jwtUser.accessToken),\r\n      ];\r\n      request.res.setHeader(\"Set-Cookie\", cookies);\r\n    }\r\n\r\n    return jwtUser;\r\n  }\r\n\r\n  @Post(\"/logout\")\r\n  @UseGuards(JwtAuthenticationGuard)\r\n  async logOut(@Req() request: RequestWithStaff | RequestWithPatient) {\r\n    if (request.res) {\r\n      const cookies = await this.cookieService.removeCookie();\r\n      request.res.setHeader(\"Set-Cookie\", cookies);\r\n    }\r\n  }\r\n}\r\n"],"names":["AuthController","signup","body","user","authService","register","loginStaff","request","staff","getByUsername","username","password","comparePassword","UnauthorizedException","jwtUser","jwtAuthService","generateJwtUser","res","accessToken","InternalServerErrorException","cookies","cookieService","generateCookie","setHeader","loginPatient","patient","getByNik","nik","logOut","removeCookie","type","SignupBody","LoginStaffBody","LoginPatientBody"],"mappings":";;;;+BA6BaA;;;eAAAA;;;wBApBN;yBAE0B;4BACN;2BACsB;+BACnB;+EACK;6BACP;yBACI;gCACD;+BAIxB;;;;;;;;;;;;;;;;;;;;AAOA,IAAA,AAAMA,iBAAN,MAAMA;IAUX,MAEMC,OAAO,AAAQC,IAAgB,EAAE;QACrC,MAAMC,OAAO,MAAM,IAAI,CAACC,WAAW,CAACC,QAAQ,CAACH;QAC7C,OAAOC;IACT;IAEA,MAEMG,WACJ,AAAOC,OAAyB,EAChC,AAAQL,IAAoB,EAC5B;QACA,MAAMM,QAAQ,MAAM,IAAI,CAACJ,WAAW,CAACK,aAAa,CAACP,KAAKQ,QAAQ;QAEhE,IACE,CAACF,OAAOG,YACR,CAAE,MAAMC,IAAAA,wBAAe,EAACJ,MAAMG,QAAQ,EAAET,KAAKS,QAAQ,GACrD;YACA,MAAM,IAAIE,6BAAqB,CAAC;QAClC;QAEA,MAAMC,UAAU,MAAM,IAAI,CAACC,cAAc,CAACC,eAAe,CACvDR;QAGF,IAAID,QAAQU,GAAG,EAAE;YACf,IAAI,CAACH,QAAQI,WAAW,EAAE;gBACxB,MAAM,IAAIC,oCAA4B,CAAC;YACzC;YAEA,MAAMC,UAAU;gBACd,MAAM,IAAI,CAACC,aAAa,CAACC,cAAc,CAACR,QAAQI,WAAW;aAC5D;YACDX,QAAQU,GAAG,CAACM,SAAS,CAAC,cAAcH;QACtC;QAEA,OAAON;IACT;IAEA,MAEMU,aACJ,AAAOjB,OAA2B,EAClC,AAAQL,IAAsB,EAC9B;QACA,MAAMuB,UAAU,MAAM,IAAI,CAACrB,WAAW,CAACsB,QAAQ,CAACxB,KAAKyB,GAAG;QAExD,IAAI,CAACF,SAAS;YACZ,MAAM,IAAIZ,6BAAqB,CAAC;QAClC;QAEA,MAAMC,UAAU,MAAM,IAAI,CAACC,cAAc,CAACC,eAAe,CAGvDS;QAEF,IAAIlB,QAAQU,GAAG,EAAE;YACf,IAAI,CAACH,QAAQI,WAAW,EAAE;gBACxB,MAAM,IAAIC,oCAA4B,CAAC;YACzC;YAEA,MAAMC,UAAU;gBACd,MAAM,IAAI,CAACC,aAAa,CAACC,cAAc,CAACR,QAAQI,WAAW;aAC5D;YACDX,QAAQU,GAAG,CAACM,SAAS,CAAC,cAAcH;QACtC;QAEA,OAAON;IACT;IAEA,MAEMc,OAAO,AAAOrB,OAA8C,EAAE;QAClE,IAAIA,QAAQU,GAAG,EAAE;YACf,MAAMG,UAAU,MAAM,IAAI,CAACC,aAAa,CAACQ,YAAY;YACrDtB,QAAQU,GAAG,CAACM,SAAS,CAAC,cAAcH;QACtC;IACF;IAvFA,YACE,AACiBhB,WAAwB,EACzC,AACiBW,cAA8B,EAC/C,AACiBM,aAA4B,CAC7C;aALiBjB,cAAAA;aAEAW,iBAAAA;aAEAM,gBAAAA;IAChB;AAiFL;;;;QA9EaS,MAAMC,sBAAU;;;;;;;;;;;;QAOhBD,MAAME,yBAAc;;;;;;;;;;;;;;QAiCpBF,MAAMG,2BAAgB"}