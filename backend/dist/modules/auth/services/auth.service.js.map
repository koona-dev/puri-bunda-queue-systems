{"version":3,"sources":["../../../../src/modules/auth/services/auth.service.ts"],"sourcesContent":["import { Inject } from \"@nestjs/common\";\r\nimport { NodePgDatabase } from \"drizzle-orm/node-postgres\";\r\nimport { DBSchemaType } from \"src/database/schemas\";\r\nimport { CreateStaff, Staff } from \"../../master/entities/staff.entity\";\r\nimport { Patients } from \"../../master/entities/patients.entity\";\r\nimport { toEnum } from \"src/utils/converter\";\r\nimport { Gender } from \"../../master/utils/gender.enum\";\r\nimport { PatientType } from \"../../master/utils/patient-type.enum\";\r\nimport { staff } from \"src/database/schemas/master.schema\";\r\nimport { generateCode } from \"src/utils/generate-code\";\r\nimport { PatientClass } from \"src/modules/master/utils/patient-class.enum\";\r\nimport { encryptPassword } from \"src/utils/encrypt\";\r\n\r\nexport class AuthService {\r\n  constructor(@Inject(\"DB_PG\") private db: NodePgDatabase<DBSchemaType>) {}\r\n\r\n  // ===========[Queries]===========\r\n  async getById(userId: string): Promise<Staff | null> {\r\n    const userRecord = await this.db.query.staff.findFirst({\r\n      where: (staff, { eq }) => eq(staff.id, userId),\r\n    });\r\n\r\n    if (!userRecord) {\r\n      return null;\r\n    }\r\n\r\n    return userRecord;\r\n  }\r\n\r\n  async getByUsername(username: string): Promise<Staff | null> {\r\n    const userRecord = await this.db.query.staff.findFirst({\r\n      where: (staff, { eq }) => eq(staff.username, username),\r\n    });\r\n\r\n    if (!userRecord) {\r\n      return null;\r\n    }\r\n\r\n    return userRecord;\r\n  }\r\n\r\n  async getByNik(nik: string): Promise<Patients | null> {\r\n    const userRecord = await this.db.query.patients.findFirst({\r\n      where: (patient, { eq }) => eq(patient.nik, nik),\r\n    });\r\n\r\n    if (!userRecord) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      ...userRecord,\r\n      gender: toEnum(userRecord.gender, Object.values(Gender)),\r\n      patientType: toEnum(userRecord.patientType, Object.values(PatientType)),\r\n      patientClass: toEnum(\r\n        userRecord.patientClass,\r\n        Object.values(PatientClass)\r\n      ),\r\n    };\r\n  }\r\n\r\n  // ===========[Commands]===========\r\n  async register(data: CreateStaff): Promise<Staff | undefined> {\r\n    try {\r\n      const hashPassword = await encryptPassword(data.password);\r\n      const staffData: Staff = {\r\n        ...data,\r\n        code: await generateCode(this.db, staff, \"code\", \"STF\"),\r\n        isActive: true,\r\n        password: hashPassword,\r\n      };\r\n\r\n      const staffRecord = await this.db\r\n        .insert(staff)\r\n        .values(staffData)\r\n        .returning();\r\n\r\n      return staffRecord[0];\r\n    } catch (error) {}\r\n  }\r\n}\r\n"],"names":["AuthService","getById","userId","userRecord","db","query","staff","findFirst","where","eq","id","getByUsername","username","getByNik","nik","patients","patient","gender","toEnum","Object","values","Gender","patientType","PatientType","patientClass","PatientClass","register","data","hashPassword","encryptPassword","password","staffData","code","generateCode","isActive","staffRecord","insert","returning","error"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBAbU;8BACQ;2BAIR;4BACA;iCACK;8BACN;8BACO;kCACA;yBACG;;;;;;;;;;;;;;;AAEzB,IAAA,AAAMA,cAAN,MAAMA;IAGX,kCAAkC;IAClC,MAAMC,QAAQC,MAAc,EAAyB;QACnD,MAAMC,aAAa,MAAM,IAAI,CAACC,EAAE,CAACC,KAAK,CAACC,KAAK,CAACC,SAAS,CAAC;YACrDC,OAAO,CAACF,OAAO,EAAEG,EAAE,EAAE,GAAKA,GAAGH,MAAMI,EAAE,EAAER;QACzC;QAEA,IAAI,CAACC,YAAY;YACf,OAAO;QACT;QAEA,OAAOA;IACT;IAEA,MAAMQ,cAAcC,QAAgB,EAAyB;QAC3D,MAAMT,aAAa,MAAM,IAAI,CAACC,EAAE,CAACC,KAAK,CAACC,KAAK,CAACC,SAAS,CAAC;YACrDC,OAAO,CAACF,OAAO,EAAEG,EAAE,EAAE,GAAKA,GAAGH,MAAMM,QAAQ,EAAEA;QAC/C;QAEA,IAAI,CAACT,YAAY;YACf,OAAO;QACT;QAEA,OAAOA;IACT;IAEA,MAAMU,SAASC,GAAW,EAA4B;QACpD,MAAMX,aAAa,MAAM,IAAI,CAACC,EAAE,CAACC,KAAK,CAACU,QAAQ,CAACR,SAAS,CAAC;YACxDC,OAAO,CAACQ,SAAS,EAAEP,EAAE,EAAE,GAAKA,GAAGO,QAAQF,GAAG,EAAEA;QAC9C;QAEA,IAAI,CAACX,YAAY;YACf,OAAO;QACT;QAEA,OAAO;YACL,GAAGA,UAAU;YACbc,QAAQC,IAAAA,iBAAM,EAACf,WAAWc,MAAM,EAAEE,OAAOC,MAAM,CAACC,kBAAM;YACtDC,aAAaJ,IAAAA,iBAAM,EAACf,WAAWmB,WAAW,EAAEH,OAAOC,MAAM,CAACG,4BAAW;YACrEC,cAAcN,IAAAA,iBAAM,EAClBf,WAAWqB,YAAY,EACvBL,OAAOC,MAAM,CAACK,8BAAY;QAE9B;IACF;IAEA,mCAAmC;IACnC,MAAMC,SAASC,IAAiB,EAA8B;QAC5D,IAAI;YACF,MAAMC,eAAe,MAAMC,IAAAA,wBAAe,EAACF,KAAKG,QAAQ;YACxD,MAAMC,YAAmB;gBACvB,GAAGJ,IAAI;gBACPK,MAAM,MAAMC,IAAAA,0BAAY,EAAC,IAAI,CAAC7B,EAAE,EAAEE,mBAAK,EAAE,QAAQ;gBACjD4B,UAAU;gBACVJ,UAAUF;YACZ;YAEA,MAAMO,cAAc,MAAM,IAAI,CAAC/B,EAAE,CAC9BgC,MAAM,CAAC9B,mBAAK,EACZc,MAAM,CAACW,WACPM,SAAS;YAEZ,OAAOF,WAAW,CAAC,EAAE;QACvB,EAAE,OAAOG,OAAO,CAAC;IACnB;IAjEA,YAAY,AAAyBlC,EAAgC,CAAE;aAAlCA,KAAAA;IAAmC;AAkE1E"}