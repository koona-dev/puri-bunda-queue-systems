{"version":3,"sources":["../../../../src/modules/master/services/patients.service.ts"],"sourcesContent":["import { Inject } from \"@nestjs/common\";\r\nimport { eq, SQL } from \"drizzle-orm\";\r\nimport { NodePgDatabase } from \"drizzle-orm/node-postgres\";\r\nimport { DBSchemaType } from \"src/database/schemas\";\r\nimport {\r\n  CreatePatient,\r\n  Patients,\r\n  PatientsProps,\r\n  UpdatePatient,\r\n} from \"../entities/patients.entity\";\r\nimport { toEnum } from \"src/utils/converter\";\r\nimport { Gender } from \"../utils/gender.enum\";\r\nimport { NewPatient, patients } from \"src/database/schemas/master.schema\";\r\nimport { generateCode } from \"src/utils/generate-code\";\r\nimport { PatientClass } from \"../utils/patient-class.enum\";\r\nimport { PatientType } from \"../utils/patient-type.enum\";\r\n\r\nclass PatientsService {\r\n  constructor(@Inject(\"DB_PG\") private db: NodePgDatabase<DBSchemaType>) {}\r\n\r\n  // ===========[Queries]===========\r\n\r\n  async findOne(query: PatientsProps): Promise<Patients | null> {\r\n    const patientRecord = await this.db.query.patients.findFirst({\r\n      where: (patient, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.id) conditions.push(eq(patient.id, query.id));\r\n        if (query.code) conditions.push(eq(patient.code, query.code));\r\n        if (query.registrationNumber)\r\n          conditions.push(\r\n            eq(patient.registrationNumber, query.registrationNumber)\r\n          );\r\n        if (query.nik) conditions.push(eq(patient.nik, query.nik));\r\n        if (query.name) conditions.push(eq(patient.name, query.name));\r\n        if (query.assuranceCode)\r\n          conditions.push(eq(patient.assuranceCode, query.assuranceCode));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    if (!patientRecord) {\r\n      return null;\r\n    }\r\n\r\n    const patientEntity: Patients = {\r\n      ...patientRecord,\r\n      patientClass: toEnum(\r\n        patientRecord.patientClass,\r\n        Object.values(PatientClass)\r\n      ),\r\n      patientType: toEnum(\r\n        patientRecord.patientType,\r\n        Object.values(PatientType)\r\n      ),\r\n      gender: toEnum(patientRecord.gender, Object.values(Gender)),\r\n    };\r\n\r\n    return patientEntity;\r\n  }\r\n\r\n  async findMany(query: PatientsProps): Promise<Patients[]> {\r\n    const patientList = await this.db.query.patients.findMany({\r\n      where: (patient, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.name) conditions.push(eq(patient.name, query.name));\r\n        if (query.birthDate)\r\n          conditions.push(eq(patient.birthDate, new Date(query.birthDate)));\r\n        if (query.gender) conditions.push(eq(patient.gender, query.gender));\r\n        if (query.address) conditions.push(eq(patient.address, query.address));\r\n        if (query.patientType)\r\n          conditions.push(eq(patient.patientType, query.patientType));\r\n        if (query.patientClass)\r\n          conditions.push(eq(patient.patientClass, query.patientClass));\r\n        if (query.haveAssurance)\r\n          conditions.push(eq(patient.haveAssurance, query.haveAssurance));\r\n        if (query.createdAt)\r\n          conditions.push(eq(patient.createdAt, query.createdAt));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    const patientListEntity = patientList.map((record) => {\r\n      return {\r\n        ...record,\r\n        patientClass: toEnum(record.patientClass, Object.values(PatientClass)),\r\n        patientType: toEnum(record.patientType, Object.values(PatientType)),\r\n        gender: toEnum(record.gender, Object.values(Gender)),\r\n      };\r\n    });\r\n\r\n    return patientListEntity;\r\n  }\r\n\r\n  // ===========[Commands]===========\r\n  async create(data: CreatePatient): Promise<Patients | undefined> {\r\n    try {\r\n      const patientData: NewPatient = {\r\n        ...data,\r\n        code: await generateCode(this.db, patients, \"code\", \"PTN\"),\r\n        registrationNumber: await generateCode(\r\n          this.db,\r\n          patients,\r\n          \"registrationNumber\",\r\n          \"REG\"\r\n        ),\r\n      };\r\n\r\n      const patientRecord = await this.db\r\n        .insert(patients)\r\n        .values(patientData)\r\n        .returning();\r\n\r\n      const patientEntity: Patients = {\r\n        ...patientRecord[0],\r\n        patientClass: toEnum(\r\n          patientRecord[0].patientClass,\r\n          Object.values(PatientClass)\r\n        ),\r\n        patientType: toEnum(\r\n          patientRecord[0].patientType,\r\n          Object.values(PatientType)\r\n        ),\r\n        gender: toEnum(patientRecord[0].gender, Object.values(Gender)),\r\n      };\r\n\r\n      return patientEntity;\r\n    } catch (error) {}\r\n  }\r\n\r\n  async update(data: UpdatePatient): Promise<Patients | undefined> {\r\n    try {\r\n      const patientRecord = await this.db\r\n        .update(patients)\r\n        .set(data)\r\n        .where(eq(patients.id, data.id))\r\n        .returning();\r\n\r\n      const patientEntity: Patients = {\r\n        ...patientRecord[0],\r\n        patientClass: toEnum(\r\n          patientRecord[0].patientClass,\r\n          Object.values(PatientClass)\r\n        ),\r\n        patientType: toEnum(\r\n          patientRecord[0].patientType,\r\n          Object.values(PatientType)\r\n        ),\r\n        gender: toEnum(patientRecord[0].gender, Object.values(Gender)),\r\n      };\r\n\r\n      return patientEntity;\r\n    } catch (error) {}\r\n  }\r\n\r\n  async delete(id: string): Promise<boolean | undefined> {\r\n    try {\r\n      const patientRecord = await this.db\r\n        .delete(patients)\r\n        .where(eq(patients.id, id))\r\n        .returning();\r\n\r\n      if (!patientRecord) {\r\n        return false;\r\n      }\r\n      return true;\r\n    } catch (error) {}\r\n  }\r\n}\r\n\r\nexport default PatientsService;\r\n"],"names":["PatientsService","findOne","query","patientRecord","db","patients","findFirst","where","patient","eq","and","conditions","id","push","code","registrationNumber","nik","name","assuranceCode","length","undefined","patientEntity","patientClass","toEnum","Object","values","PatientClass","patientType","PatientType","gender","Gender","findMany","patientList","birthDate","Date","address","haveAssurance","createdAt","patientListEntity","map","record","create","data","patientData","generateCode","insert","returning","error","update","set","delete"],"mappings":"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"}