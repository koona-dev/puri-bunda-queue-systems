{"version":3,"sources":["../../../../src/modules/master/services/patients.service.ts"],"sourcesContent":["import { Inject } from \"@nestjs/common\";\r\nimport { eq, SQL } from \"drizzle-orm\";\r\nimport { NodePgDatabase } from \"drizzle-orm/node-postgres\";\r\nimport { DBSchemaType } from \"src/database/schemas\";\r\nimport {\r\n  CreatePatient,\r\n  Patients,\r\n  PatientsProps,\r\n  UpdatePatient,\r\n} from \"../entities/patients.entity\";\r\nimport { toEnum } from \"src/utils/converter\";\r\nimport { Gender } from \"../utils/gender.enum\";\r\nimport { patients } from \"src/database/schemas/master.schema\";\r\nimport { generateCode } from \"src/utils/generate-code\";\r\nimport { PatientClass } from \"../utils/patient-class.enum\";\r\nimport { PatientType } from \"../utils/patient-type.enum\";\r\n\r\nclass PatientsService {\r\n  constructor(@Inject(\"DB_PG\") private db: NodePgDatabase<DBSchemaType>) {}\r\n\r\n  // ===========[Queries]===========\r\n  async findById(id: string): Promise<Patients | null> {\r\n    const patientRecord = await this.db.query.patients.findFirst({\r\n      where: (patient, { eq }) => eq(patient.id, id),\r\n    });\r\n\r\n    if (!patientRecord) {\r\n      return null;\r\n    }\r\n\r\n    const patientEntity: Patients = {\r\n      ...patientRecord,\r\n      patientClass: toEnum(\r\n        patientRecord.patientClass,\r\n        Object.values(PatientClass)\r\n      ),\r\n      patientType: toEnum(\r\n        patientRecord.patientType,\r\n        Object.values(PatientType)\r\n      ),\r\n      gender: toEnum(patientRecord.gender, Object.values(Gender)),\r\n    };\r\n\r\n    return patientEntity;\r\n  }\r\n\r\n  async findOne(query: PatientsProps): Promise<Patients | null> {\r\n    const patientRecord = await this.db.query.patients.findFirst({\r\n      where: (patient, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.id) conditions.push(eq(patient.id, query.id));\r\n        if (query.code) conditions.push(eq(patient.code, query.code));\r\n        if (query.registrationNumber)\r\n          conditions.push(\r\n            eq(patient.registrationNumber, query.registrationNumber)\r\n          );\r\n        if (query.nik) conditions.push(eq(patient.nik, query.nik));\r\n        if (query.name) conditions.push(eq(patient.name, query.name));\r\n        if (query.assuranceCode)\r\n          conditions.push(eq(patient.assuranceCode, query.assuranceCode));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    if (!patientRecord) {\r\n      return null;\r\n    }\r\n\r\n    const patientEntity: Patients = {\r\n      ...patientRecord,\r\n      patientClass: toEnum(\r\n        patientRecord.patientClass,\r\n        Object.values(PatientClass)\r\n      ),\r\n      patientType: toEnum(\r\n        patientRecord.patientType,\r\n        Object.values(PatientType)\r\n      ),\r\n      gender: toEnum(patientRecord.gender, Object.values(Gender)),\r\n    };\r\n\r\n    return patientEntity;\r\n  }\r\n\r\n  async findMany(query: PatientsProps): Promise<Patients[]> {\r\n    const patientList = await this.db.query.patients.findMany({\r\n      where: (patient, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.name) conditions.push(eq(patient.name, query.name));\r\n        if (query.birthDate)\r\n          conditions.push(eq(patient.birthDate, new Date(query.birthDate)));\r\n        if (query.gender) conditions.push(eq(patient.gender, query.gender));\r\n        if (query.address) conditions.push(eq(patient.address, query.address));\r\n        if (query.patientType)\r\n          conditions.push(eq(patient.patientType, query.patientType));\r\n        if (query.patientClass)\r\n          conditions.push(eq(patient.patientClass, query.patientClass));\r\n        if (query.haveAssurance)\r\n          conditions.push(eq(patient.haveAssurance, query.haveAssurance));\r\n        if (query.createdAt)\r\n          conditions.push(eq(patient.createdAt, query.createdAt));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    const patientListEntity = patientList.map((record) => {\r\n      return {\r\n        ...record,\r\n        patientClass: toEnum(record.patientClass, Object.values(PatientClass)),\r\n        patientType: toEnum(record.patientType, Object.values(PatientType)),\r\n        gender: toEnum(record.gender, Object.values(Gender)),\r\n      };\r\n    });\r\n\r\n    return patientListEntity;\r\n  }\r\n\r\n  // ===========[Commands]===========\r\n  async create(data: CreatePatient): Promise<Patients | undefined> {\r\n    try {\r\n      const patientData: Patients = {\r\n        ...data,\r\n        code: await generateCode(this.db, patients, patients.code, \"code\"),\r\n        registrationNumber: await generateCode(\r\n          this.db,\r\n          patients,\r\n          patients.registrationNumber,\r\n          \"registrationNumber\"\r\n        ),\r\n      };\r\n\r\n      const patientRecord = await this.db\r\n        .insert(patients)\r\n        .values(patientData)\r\n        .returning();\r\n\r\n      const patientEntity: Patients = {\r\n        ...patientRecord[0],\r\n        patientClass: toEnum(\r\n          patientRecord[0].patientClass,\r\n          Object.values(PatientClass)\r\n        ),\r\n        patientType: toEnum(\r\n          patientRecord[0].patientType,\r\n          Object.values(PatientType)\r\n        ),\r\n        gender: toEnum(patientRecord[0].gender, Object.values(Gender)),\r\n      };\r\n\r\n      return patientEntity;\r\n    } catch (error) {}\r\n  }\r\n\r\n  async update(data: UpdatePatient): Promise<Patients | undefined> {\r\n    try {\r\n      const patientRecord = await this.db\r\n        .update(patients)\r\n        .set(data)\r\n        .where(eq(patients.id, data.id))\r\n        .returning();\r\n\r\n      const patientEntity: Patients = {\r\n        ...patientRecord[0],\r\n        patientClass: toEnum(\r\n          patientRecord[0].patientClass,\r\n          Object.values(PatientClass)\r\n        ),\r\n        patientType: toEnum(\r\n          patientRecord[0].patientType,\r\n          Object.values(PatientType)\r\n        ),\r\n        gender: toEnum(patientRecord[0].gender, Object.values(Gender)),\r\n      };\r\n\r\n      return patientEntity;\r\n    } catch (error) {}\r\n  }\r\n\r\n  async delete(id: string): Promise<boolean | undefined> {\r\n    try {\r\n      const patientRecord = await this.db\r\n        .delete(patients)\r\n        .where(eq(patients.id, id))\r\n        .returning();\r\n\r\n      if (!patientRecord) {\r\n        return false;\r\n      }\r\n      return true;\r\n    } catch (error) {}\r\n  }\r\n}\r\n\r\nexport default PatientsService;\r\n"],"names":["PatientsService","findById","id","patientRecord","db","query","patients","findFirst","where","patient","eq","patientEntity","patientClass","toEnum","Object","values","PatientClass","patientType","PatientType","gender","Gender","findOne","and","conditions","push","code","registrationNumber","nik","name","assuranceCode","length","undefined","findMany","patientList","birthDate","Date","address","haveAssurance","createdAt","patientListEntity","map","record","create","data","patientData","generateCode","insert","returning","error","update","set","delete"],"mappings":"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"}