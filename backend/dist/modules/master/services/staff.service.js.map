{"version":3,"sources":["../../../../src/modules/master/services/staff.service.ts"],"sourcesContent":["import { Inject } from \"@nestjs/common\";\r\nimport { eq, SQL } from \"drizzle-orm\";\r\nimport { NodePgDatabase } from \"drizzle-orm/node-postgres\";\r\n\r\nimport { DBSchemaType } from \"src/database/schemas\";\r\nimport { staff } from \"src/database/schemas/master.schema\";\r\nimport { generateCode } from \"src/utils/generate-code\";\r\nimport {\r\n  CreateStaff,\r\n  Staff,\r\n  StaffProps,\r\n  UpdateStaff,\r\n} from \"../entities/staff.entity\";\r\n\r\nclass StaffService {\r\n  constructor(@Inject(\"DB_PG\") private db: NodePgDatabase<DBSchemaType>) {}\r\n\r\n  // ===========[Queries]===========\r\n\r\n  async findOne(query: StaffProps): Promise<Staff | null> {\r\n    const staffRecord = await this.db.query.staff.findFirst({\r\n      where: (staff, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.id) conditions.push(eq(staff.id, query.id));\r\n        if (query.code) conditions.push(eq(staff.code, query.code));\r\n        if (query.email) conditions.push(eq(staff.email, query.email));\r\n        if (query.nik) conditions.push(eq(staff.nik, query.nik));\r\n        if (query.name) conditions.push(eq(staff.name, query.name));\r\n        if (query.address) conditions.push(eq(staff.address, query.address));\r\n        if (query.loketNumber)\r\n          conditions.push(eq(staff.loketNumber, query.loketNumber));\r\n        if (query.phone) conditions.push(eq(staff.phone, query.phone));\r\n        if (query.isActive) conditions.push(eq(staff.isActive, query.isActive));\r\n        if (query.createdAt)\r\n          conditions.push(eq(staff.createdAt, query.createdAt));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    if (!staffRecord) {\r\n      return null;\r\n    }\r\n\r\n    return staffRecord;\r\n  }\r\n\r\n  async findMany(query: StaffProps): Promise<Staff[]> {\r\n    const staffList = await this.db.query.staff.findMany({\r\n      where: (staff, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.id) conditions.push(eq(staff.id, query.id));\r\n        if (query.code) conditions.push(eq(staff.code, query.code));\r\n        if (query.email) conditions.push(eq(staff.email, query.email));\r\n        if (query.nik) conditions.push(eq(staff.nik, query.nik));\r\n        if (query.name) conditions.push(eq(staff.name, query.name));\r\n        if (query.address) conditions.push(eq(staff.address, query.address));\r\n        if (query.loketNumber)\r\n          conditions.push(eq(staff.loketNumber, query.loketNumber));\r\n        if (query.phone) conditions.push(eq(staff.phone, query.phone));\r\n        if (query.isActive) conditions.push(eq(staff.isActive, query.isActive));\r\n        if (query.createdAt)\r\n          conditions.push(eq(staff.createdAt, query.createdAt));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    return staffList;\r\n  }\r\n\r\n  // ===========[Commands]===========\r\n  async create(data: CreateStaff): Promise<Staff | undefined> {\r\n    try {\r\n      const staffData: Staff = {\r\n        ...data,\r\n        isActive: true,\r\n\r\n        code: await generateCode(this.db, staff, \"code\", \"STF\"),\r\n      };\r\n\r\n      const staffRecord = await this.db\r\n        .insert(staff)\r\n        .values(staffData)\r\n        .returning();\r\n\r\n      return staffRecord[0];\r\n    } catch (error) {}\r\n  }\r\n\r\n  async update(data: UpdateStaff): Promise<Staff | undefined> {\r\n    try {\r\n      const staffRecord = await this.db\r\n        .update(staff)\r\n        .set(data)\r\n        .where(eq(staff.id, data.id))\r\n        .returning();\r\n\r\n      return staffRecord[0];\r\n    } catch (error) {}\r\n  }\r\n\r\n  async delete(id: string): Promise<boolean | undefined> {\r\n    try {\r\n      const staffRecord = await this.db\r\n        .delete(staff)\r\n        .where(eq(staff.id, id))\r\n        .returning();\r\n\r\n      if (!staffRecord) {\r\n        return false;\r\n      }\r\n      return true;\r\n    } catch (error) {}\r\n  }\r\n}\r\n\r\nexport default StaffService;\r\n"],"names":["StaffService","findOne","query","staffRecord","db","staff","findFirst","where","eq","and","conditions","id","push","code","email","nik","name","address","loketNumber","phone","isActive","createdAt","length","undefined","findMany","staffList","create","data","staffData","generateCode","insert","values","returning","error","update","set","delete"],"mappings":"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"}