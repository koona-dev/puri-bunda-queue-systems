{"version":3,"sources":["../../../../src/modules/master/services/staff.service.ts"],"sourcesContent":["import { Inject } from \"@nestjs/common\";\r\nimport { eq, SQL } from \"drizzle-orm\";\r\nimport { NodePgDatabase } from \"drizzle-orm/node-postgres\";\r\n\r\nimport { DBSchemaType } from \"src/database/schemas\";\r\nimport { staff } from \"src/database/schemas/master.schema\";\r\nimport { generateCode } from \"src/utils/generate-code\";\r\nimport {\r\n  CreateStaff,\r\n  Staff,\r\n  StaffProps,\r\n  UpdateStaff,\r\n} from \"../entities/staff.entity\";\r\n\r\nclass StaffService {\r\n  constructor(@Inject(\"DB_PG\") private db: NodePgDatabase<DBSchemaType>) {}\r\n\r\n  // ===========[Queries]===========\r\n  async findById(id: string): Promise<Staff | null> {\r\n    const staffRecord = await this.db.query.staff.findFirst({\r\n      where: (staff, { eq }) => eq(staff.id, id),\r\n    });\r\n\r\n    if (!staffRecord) {\r\n      return null;\r\n    }\r\n\r\n    return staffRecord;\r\n  }\r\n\r\n  async findOne(query: StaffProps): Promise<Staff | null> {\r\n    const staffRecord = await this.db.query.staff.findFirst({\r\n      where: (staff, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.id) conditions.push(eq(staff.id, query.id));\r\n        if (query.code) conditions.push(eq(staff.code, query.code));\r\n        if (query.email) conditions.push(eq(staff.email, query.email));\r\n        if (query.nik) conditions.push(eq(staff.nik, query.nik));\r\n        if (query.name) conditions.push(eq(staff.name, query.name));\r\n        if (query.address) conditions.push(eq(staff.address, query.address));\r\n        if (query.loketNumber)\r\n          conditions.push(eq(staff.loketNumber, query.loketNumber));\r\n        if (query.phone) conditions.push(eq(staff.phone, query.phone));\r\n        if (query.isActive) conditions.push(eq(staff.isActive, query.isActive));\r\n        if (query.createdAt)\r\n          conditions.push(eq(staff.createdAt, query.createdAt));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    if (!staffRecord) {\r\n      return null;\r\n    }\r\n\r\n    return staffRecord;\r\n  }\r\n\r\n  async findMany(query: StaffProps): Promise<Staff[]> {\r\n    const staffList = await this.db.query.staff.findMany({\r\n      where: (staff, { eq, and }) => {\r\n        const conditions: SQL[] = [];\r\n\r\n        if (query.id) conditions.push(eq(staff.id, query.id));\r\n        if (query.code) conditions.push(eq(staff.code, query.code));\r\n        if (query.email) conditions.push(eq(staff.email, query.email));\r\n        if (query.nik) conditions.push(eq(staff.nik, query.nik));\r\n        if (query.name) conditions.push(eq(staff.name, query.name));\r\n        if (query.address) conditions.push(eq(staff.address, query.address));\r\n        if (query.loketNumber)\r\n          conditions.push(eq(staff.loketNumber, query.loketNumber));\r\n        if (query.phone) conditions.push(eq(staff.phone, query.phone));\r\n        if (query.isActive) conditions.push(eq(staff.isActive, query.isActive));\r\n        if (query.createdAt)\r\n          conditions.push(eq(staff.createdAt, query.createdAt));\r\n\r\n        return conditions.length > 0 ? and(...conditions) : undefined;\r\n      },\r\n    });\r\n\r\n    return staffList;\r\n  }\r\n\r\n  // ===========[Commands]===========\r\n  async create(data: CreateStaff): Promise<Staff | undefined> {\r\n    try {\r\n      const staffData: Staff = {\r\n        ...data,\r\n        isActive: true,\r\n\r\n        code: await generateCode(this.db, staff, staff.code, \"code\"),\r\n      };\r\n\r\n      const staffRecord = await this.db\r\n        .insert(staff)\r\n        .values(staffData)\r\n        .returning();\r\n\r\n      return staffRecord[0];\r\n    } catch (error) {}\r\n  }\r\n\r\n  async update(data: UpdateStaff): Promise<Staff | undefined> {\r\n    try {\r\n      const staffRecord = await this.db\r\n        .update(staff)\r\n        .set(data)\r\n        .where(eq(staff.id, data.id))\r\n        .returning();\r\n\r\n      return staffRecord[0];\r\n    } catch (error) {}\r\n  }\r\n\r\n  async delete(id: string): Promise<boolean | undefined> {\r\n    try {\r\n      const staffRecord = await this.db\r\n        .delete(staff)\r\n        .where(eq(staff.id, id))\r\n        .returning();\r\n\r\n      if (!staffRecord) {\r\n        return false;\r\n      }\r\n      return true;\r\n    } catch (error) {}\r\n  }\r\n}\r\n\r\nexport default StaffService;\r\n"],"names":["StaffService","findById","id","staffRecord","db","query","staff","findFirst","where","eq","findOne","and","conditions","push","code","email","nik","name","address","loketNumber","phone","isActive","createdAt","length","undefined","findMany","staffList","create","data","staffData","generateCode","insert","values","returning","error","update","set","delete"],"mappings":"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"}