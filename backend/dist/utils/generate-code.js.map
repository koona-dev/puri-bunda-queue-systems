{"version":3,"sources":["../../src/utils/generate-code.ts"],"sourcesContent":["import { desc, like } from \"drizzle-orm\";\r\nimport { NodePgDatabase } from \"drizzle-orm/node-postgres\";\r\nimport { PgColumn, PgTable } from \"drizzle-orm/pg-core\";\r\nimport { DBSchemaType } from \"src/database/schemas\";\r\n\r\nexport async function generateCode(\r\n  db: NodePgDatabase<DBSchemaType | Record<string, never>>,\r\n  schema: PgTable,\r\n  field: PgColumn,\r\n  key: string\r\n): Promise<string> {\r\n  const prefix = \"DM\";\r\n  const now = new Date();\r\n\r\n  const datePart = `${now.getFullYear()}/${String(now.getMonth() + 1).padStart(2, \"0\")}/${String(now.getDate()).padStart(2, \"0\")}`;\r\n\r\n  const latestData = await db\r\n    .select()\r\n    .from(schema)\r\n    .where(like(field, `${datePart}%`))\r\n    .orderBy(desc(field));\r\n\r\n  let nextNumber = 1;\r\n  if (latestData && latestData.length > 0) {\r\n    // Type assertion\r\n    const codeValue = (latestData[0] as any)[key] as string;\r\n    const parts = codeValue.split(\"/\");\r\n    const lastNum = parseInt(parts[1], 10);\r\n    nextNumber = lastNum + 1;\r\n  }\r\n\r\n  const newCode = `${prefix}${String(nextNumber).padStart(3, \"0\")}/${datePart}`;\r\n  return newCode;\r\n}\r\n"],"names":["generateCode","db","schema","field","key","prefix","now","Date","datePart","getFullYear","String","getMonth","padStart","getDate","latestData","select","from","where","like","orderBy","desc","nextNumber","length","codeValue","parts","split","lastNum","parseInt","newCode"],"mappings":";;;;+BAKsBA;;;eAAAA;;;4BALK;AAKpB,eAAeA,aACpBC,EAAwD,EACxDC,MAAe,EACfC,KAAe,EACfC,GAAW;IAEX,MAAMC,SAAS;IACf,MAAMC,MAAM,IAAIC;IAEhB,MAAMC,WAAW,GAAGF,IAAIG,WAAW,GAAG,CAAC,EAAEC,OAAOJ,IAAIK,QAAQ,KAAK,GAAGC,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAEF,OAAOJ,IAAIO,OAAO,IAAID,QAAQ,CAAC,GAAG,MAAM;IAEhI,MAAME,aAAa,MAAMb,GACtBc,MAAM,GACNC,IAAI,CAACd,QACLe,KAAK,CAACC,IAAAA,gBAAI,EAACf,OAAO,GAAGK,SAAS,CAAC,CAAC,GAChCW,OAAO,CAACC,IAAAA,gBAAI,EAACjB;IAEhB,IAAIkB,aAAa;IACjB,IAAIP,cAAcA,WAAWQ,MAAM,GAAG,GAAG;QACvC,iBAAiB;QACjB,MAAMC,YAAY,AAACT,UAAU,CAAC,EAAE,AAAQ,CAACV,IAAI;QAC7C,MAAMoB,QAAQD,UAAUE,KAAK,CAAC;QAC9B,MAAMC,UAAUC,SAASH,KAAK,CAAC,EAAE,EAAE;QACnCH,aAAaK,UAAU;IACzB;IAEA,MAAME,UAAU,GAAGvB,SAASK,OAAOW,YAAYT,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAEJ,UAAU;IAC7E,OAAOoB;AACT"}