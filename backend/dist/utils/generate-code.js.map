{"version":3,"sources":["../../src/utils/generate-code.ts"],"sourcesContent":["import { desc, sql } from \"drizzle-orm\";\r\nimport { NodePgDatabase } from \"drizzle-orm/node-postgres\";\r\nimport { PgTable } from \"drizzle-orm/pg-core\";\r\nimport { DBSchemaType } from \"src/database/schemas\";\r\n\r\nexport async function generateCode(\r\n  db: NodePgDatabase<DBSchemaType | Record<string, never>>,\r\n  schema: PgTable,\r\n  key: string,\r\n  prefix: string\r\n): Promise<string> {\r\n  const now = new Date();\r\n\r\n  const datePart = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, \"0\")}-${String(now.getDate()).padStart(2, \"0\")}`;\r\n\r\n  const latestData = await db\r\n    .select({\r\n      lastNumber: sql<number>`\r\n      CAST(substring(${schema[key]} from '(\\\\d+)$') AS INTEGER)\r\n    `,\r\n    })\r\n    .from(schema)\r\n    .orderBy(\r\n      desc(\r\n        sql<number>`CAST(substring(${schema[key]} from '(\\\\d+)$') AS INTEGER)`\r\n      )\r\n    )\r\n    .limit(1);\r\n\r\n  let nextNumber = 1;\r\n  if (latestData && latestData.length > 0) {\r\n    nextNumber = latestData[0].lastNumber + 1;\r\n  }\r\n\r\n  const newCode = `${prefix}-${datePart}-${String(nextNumber).padStart(3, \"0\")}`;\r\n  return newCode;\r\n}\r\n"],"names":["generateCode","db","schema","key","prefix","now","Date","datePart","getFullYear","String","getMonth","padStart","getDate","latestData","select","lastNumber","sql","from","orderBy","desc","limit","nextNumber","length","newCode"],"mappings":";;;;+BAKsBA;;;eAAAA;;;4BALI;AAKnB,eAAeA,aACpBC,EAAwD,EACxDC,MAAe,EACfC,GAAW,EACXC,MAAc;IAEd,MAAMC,MAAM,IAAIC;IAEhB,MAAMC,WAAW,GAAGF,IAAIG,WAAW,GAAG,CAAC,EAAEC,OAAOJ,IAAIK,QAAQ,KAAK,GAAGC,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAEF,OAAOJ,IAAIO,OAAO,IAAID,QAAQ,CAAC,GAAG,MAAM;IAEhI,MAAME,aAAa,MAAMZ,GACtBa,MAAM,CAAC;QACNC,YAAYC,IAAAA,eAAG,CAAQ,CAAC;qBACT,EAAEd,MAAM,CAACC,IAAI,CAAC;IAC/B,CAAC;IACD,GACCc,IAAI,CAACf,QACLgB,OAAO,CACNC,IAAAA,gBAAI,EACFH,IAAAA,eAAG,CAAQ,CAAC,eAAe,EAAEd,MAAM,CAACC,IAAI,CAAC,4BAA4B,CAAC,GAGzEiB,KAAK,CAAC;IAET,IAAIC,aAAa;IACjB,IAAIR,cAAcA,WAAWS,MAAM,GAAG,GAAG;QACvCD,aAAaR,UAAU,CAAC,EAAE,CAACE,UAAU,GAAG;IAC1C;IAEA,MAAMQ,UAAU,GAAGnB,OAAO,CAAC,EAAEG,SAAS,CAAC,EAAEE,OAAOY,YAAYV,QAAQ,CAAC,GAAG,MAAM;IAC9E,OAAOY;AACT"}